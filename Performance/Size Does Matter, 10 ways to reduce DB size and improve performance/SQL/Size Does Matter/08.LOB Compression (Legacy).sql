/****************************************************************************/
/*    Size Does Matter: 10 Ways to Reduce DB Size and Improve Performance   */
/*                                                                          */
/*                  Written by Dmitri V. Korotkevitch                       */
/*                      http://aboutsqlserver.com                           */
/*                        dk@aboutsqlserver.com                             */
/****************************************************************************/
/*                  LOB Compression (Before SQL Server 2016)                */
/****************************************************************************/
use [SQLServerInternals]
go

/* 
EXEC sp_configure 'clr enabled', 1;  
RECONFIGURE;  
GO  
*/
if exists(select * from sys.views v join sys.schemas s on v.schema_id = s.schema_id where v.name = 'vDataWithXML' and s.name = 'dbo') drop view dbo.vDataWithXML;
if exists(select * from sys.tables t join sys.schemas s on t.schema_id = s.schema_id where t.name = 'DataWithXML' and s.name = 'dbo') drop table dbo.DataWithXML;
if exists(select * from sys.tables t join sys.schemas s on t.schema_id = s.schema_id where t.name = 'DataWithCompressedXML' and s.name = 'dbo') drop table dbo.DataWithCompressedXML;
if object_id(N'dbo.fnGetCompressedObjectId') is not null drop function [dbo].fnGetCompressedObjectId;
if object_id(N'dbo.BinaryCompress') is not null drop function [dbo].[BinaryCompress];
if object_id(N'dbo.BinaryDecompress') is not null drop function [dbo].[BinaryDecompress];
if object_id(N'dbo.GetObjId') is not null drop function [dbo].GetObjId;
if exists(select * from sys.assemblies where name = 'LOBCompress') drop assembly LOBCompress;

create table dbo.DataWithXML
(
	ID int not null,
	Data xml not null,

	constraint PK_DataWithXML
	primary key clustered(ID)
	on [Entities]
)
go

declare
	@X xml

;with n1(c) as (select 0 union all select 0) -- 2 rows
,n2(c) as (select 0 from n1 as t1 cross join n1 as t2) -- 4 rows
select @X = 
	(
		select *
		from master.sys.objects --cross join n2
		for xml raw, root('Data')
	)

--select datalength(@X)

;with n1(c) as (select 0 union all select 0) -- 2 rows
,n2(c) as (select 0 from n1 as t1 cross join n1 as t2) -- 4 rows
,n3(c) as (select 0 from n2 as t1 cross join n2 as t2) -- 16 rows
,n4(c) as (select 0 from n3 as t1 cross join n3 as t2) -- 256 rows
,n5(c) as (select 0 from n4 as t1 cross join n3 as t2) -- 4,096 rows
,ids(id) as (select row_number() over (order by (select null)) from n5)
insert into dbo.DataWithXML(ID,Data)
	select id, @X
	from Ids
go

update dbo.DataWithXML
set Data.modify('replace value of (/Data/row/@object_id)[1]
with sql:column("ID")')
go


select 
    index_id, partition_number, alloc_unit_type_desc
    ,index_level
	,page_count
	,page_count * 8 / 1024 as [Size MB],'',''
from 
    sys.dm_db_index_physical_stats
    (
        db_id() /*Database */
        ,object_id(N'dbo.DataWithXML') /* Table (Object_ID) */
        ,1 /* Index ID */
        ,null /* Partition ID – NULL – all partitions */
        ,'detailed' /* Mode */
    )
go

select avg(datalength(Data)) as [Avg XML Size] 
from dbo.DataWithXML
go

create assembly LOBCompress
authorization dbo
from 
	0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300BB34EA540000000000000000E00002210B010B00000E00000006000000000000FE2B0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000A82B00005300000000400000B002000000000000000000000000000000000000006000000C000000702A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000040C000000200000000E000000020000000000000000000000000000200000602E72737263000000B0020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000E02B00000000000048000000020005002C2300004407000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300400800000000100001100026F0500000A16FE010D092D08280600000A0C2B67730700000A0A00061717730800000A0B0007026F0900000A16026F0900000A8E696F0A00000A00076F0B00000A00076F0C00000A0000DE100714FE010D092D07076F0D00000A00DC00066F0E00000A730F00000A0CDE100614FE010D092D07066F0D00000A00DC00082A011C000002002600284E00100000000002001C00516D0010000000001B300400990000000200001100026F0500000A16FE01130611062D09280600000A13052B7C20008000000A068D0E0000010B730700000A0C00026F1000000A1617730800000A0D002B0B08071611046F0A00000A00090716066F1100000A25130416FE02130611062DE000DE120914FE01130611062D07096F0D00000A00DC00086F0E00000A730F00000A1305DE120814FE01130611062D07086F0D00000A00DC0011052A000000011C000002003B00266100120000000002002C0057830012000000001B300400340100000300001100026F0500000A16FE01130911092D0C7E1200000A1308381401000020008000000A068D0E0000010B730700000A0C00026F1000000A1617730800000A0D002B0B08071611046F0A00000A00090716066F1100000A25130416FE02130911092DE000DE120914FE01130911092D07096F0D00000A00DC0008166A6F1300000A0008281400000A1305002B690011056F1500000A17331611056F1600000A7201000070281700000A16FE012B011700130911092D3F00110572090000706F1800000A13061106281900000A2D0B11061207281A00000A2B011600130911092D097E1200000A1308DE481107731B00000A1308DE3D0011056F1C00000A130911092D8A7E1200000A1308DE26110514FE01130911092D0811056F0D00000A00DC0814FE01130911092D07086F0D00000A00DC0011082A0128000002003E00266400120000000002008800820A01140000000002002F00EF1E0112000000001E02281D00000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C0000005C020000237E0000C8020000B402000023537472696E6773000000007C05000020000000235553009C050000100000002347554944000000AC0500009801000023426C6F620000000000000002000001471502000900000000FA25330016000001000000120000000200000004000000030000001D0000000600000003000000010000000400000000000A00010000000000060033002C000A005B0046000A00840046000600B500A2001300C90000000600F800D80006001801D8000A005D0142010600900186010E00B3019D010600C10186010E00C8019D010600F5012C00060011022C00120043023802120054023802060076022C000600A4022C000000000001000000000001000100010010001A000000050001000100502000000000960064000A000100F82000000000960073000A000200BC210000000096008D00110003002423000000008618960018000400000001009C00000001009C00000001009C00210096001C0031009600220039009600180041009600180011007201D80011007D01DC0049009600180051009600E1001100D801EA005900E301EF005900E90118005900EF01180069000102180049000902EA0011009600F700110016020701590021020C0119002602220159002B02260179004D022B0179006002320179006D02370189007D023B017900890241018900960246019100AA024B0119009600220079002102D8000900960018002000230027002E001B0076012E000B0064012E0013006D01400023002700600023002700FD001401520104800000000000000000000000000000000036010000020000000000000000000000010023000000000002000000000000000000000001003A000000000002000000000000000000000001002C000000000002000000000000000000000001003802000000000000003C4D6F64756C653E004C4F42436F6D70726573732E646C6C00436F6D7072657373006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C42797465730042696E617279436F6D70726573730042696E6172794465636F6D70726573730053716C496E743332004765744F626A4964002E63746F7200696E7075740053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004C4F42436F6D7072657373004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465006765745F49734E756C6C006765745F4E756C6C0053797374656D2E494F004D656D6F727953747265616D0053797374656D2E494F2E436F6D7072657373696F6E004465666C61746553747265616D0053747265616D00436F6D7072657373696F6E4D6F6465006765745F42756666657200577269746500466C75736800436C6F73650049446973706F7361626C6500446973706F736500546F41727261790042797465006765745F53747265616D0052656164004E756C6C007365745F506F736974696F6E0053797374656D2E586D6C00586D6C5265616465720043726561746500586D6C4E6F646554797065006765745F4E6F646554797065006765745F4E616D6500537472696E67006F705F457175616C697479004765744174747269627574650049734E756C6C4F72456D70747900496E7433320054727950617273650000000772006F00770000136F0062006A006500630074005F006900640000000000E7B53570F640414CB3E716564D9AB6460008B77A5C561934E08906000112091209060001110D120903200001052001011115042001010880AF0100030054020F497344657465726D696E697374696301540209497350726563697365015455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000003200002040000120908200301122D1131020420001D05072003011D050808052001011D0509070412251229120902042000122D072003081D0508080D0707081D0512251229081209020306110D042001010A060001123D122D04200011410320000E050002020E0E0420010E0E040001020E060002020E100811070A081D051225122908123D0E08110D020801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000000000BB34EA5400000000020000001C0100008C2A00008C0C000052534453BD8FB3FB1E1D6C4C9A866A396E2DB75202000000653A5C576F726B5C576F726B5C56535C4C4F42436F6D70726573735C4C4F42436F6D70726573735C6F626A5C44656275675C4C4F42436F6D70726573732E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D02B00000000000000000000EE2B0000002000000000000000000000000000000000000000000000E02B000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000540200000000000000000000540234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004B4010000010053007400720069006E006700460069006C00650049006E0066006F0000009001000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000040001000010049006E007400650072006E0061006C004E0061006D00650000004C004F00420043006F006D00700072006500730073002E0064006C006C0000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000004800100001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004C004F00420043006F006D00700072006500730073002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000003C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
go

create function dbo.BinaryCompress(@input varbinary (max))
returns varbinary (max)
as external name [LOBCompress].[Compress].[BinaryCompress];
go

create function dbo.BinaryDecompress(@input varbinary (max))
returns varbinary (max)
as external name [LOBCompress].[Compress].[BinaryDecompress];
go

create function dbo.GetObjId(@input varbinary (max))
returns int
as external name [LOBCompress].[Compress].[GetObjId]
go

create table dbo.DataWithCompressedXML
(
	ID int not null,
	Data varbinary(max) not null,

	constraint PK_DataWithCompressedXML
	primary key clustered(ID)
	on [Entities]
)
go

insert into dbo.DataWithCompressedXML(ID,Data)
	select ID, dbo.BinaryCompress(convert(varbinary(max),Data))
	from dbo.DataWithXML
go

select avg(datalength(Data)) as [Uncompressed] 
from dbo.DataWithXML

select avg(datalength(Data)) as [Compressed] 
from dbo.DataWithCompressedXML
go

select 
    index_id, partition_number, alloc_unit_type_desc
    ,index_level
	,page_count
	,page_count * 8 / 1024 as [Size MB] , '' ,''
from 
    sys.dm_db_index_physical_stats
    (
        db_id() /*Database */
        ,object_id(N'dbo.DataWithCompressedXML') /* Table (Object_ID) */
        ,1 /* Index ID */
        ,null /* Partition ID – NULL – all partitions */
        ,'detailed' /* Mode */
    )
go

create view dbo.vDataWithXML(ID, Data)
as
	select ID, convert(xml,dbo.BinaryDecompress(Data))
	from dbo.DataWithCompressedXML
go

select top 1 * from dbo.vDataWithXML
go

set statistics time on
select count(*) 
from dbo.DataWithXML 
where Data.value('(/Data/row/@object_id)[1]','int') = 3;

select count(*) 
from dbo.vDataWithXML 
where Data.value('(/Data/row/@object_id)[1]','int') = 3;
set statistics time off
go

create function dbo.fnGetCompressedObjectId(@Compressed varbinary(max))
returns int
with schemabinding
as
begin
	return (convert(xml,dbo.BinaryDecompress(@Compressed)).value('(/Data/row/@object_id)[1]','int'))
end
go	 

alter table dbo.DataWithCompressedXML
add
	ObjId as dbo.fnGetCompressedObjectId(Data)
	persisted
go

--alter index PK_DataWithCompressedXML on dbo.DataWithCompressedXML rebuild
go

alter view dbo.vDataWithXML(ID, Data, ObjId)
as
	select ID, convert(xml,dbo.BinaryDecompress(Data)), ObjId
	from dbo.DataWithCompressedXML
go


set statistics time on
select count(*) from dbo.DataWithXML where Data.value('(/Data/row/@object_id)[1]','int') = 3
select count(*) from dbo.vDataWithXML where ObjId = 3
set statistics time off
go

select top 1 * from DataWithCompressedXML
go

alter table dbo.DataWithCompressedXML drop column ObjId
go

alter table dbo.DataWithCompressedXML
add
	ObjId as dbo.GetObjId(Data)
	persisted
go

alter index PK_DataWithCompressedXML on dbo.DataWithCompressedXML rebuild
go

set statistics time on
select count(*) from dbo.DataWithXML where Data.value('(/Data/row/@object_id)[1]','int') = 3
select count(*) from dbo.vDataWithXML where ObjId = 3
set statistics time off
go